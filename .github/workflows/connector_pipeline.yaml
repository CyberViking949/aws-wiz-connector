name: Check for WIZ CFN Updates

on:
    schedule:
      - cron: '0 0 * * *' # Runs daily at midnight
    workflow_dispatch: # Allows manual trigger

permissions:
  id-token: write # This is required for requesting the JWT
  contents: write  # This is required for actions/checkout
  pull-requests: write # This is required to Write the PR Comment

jobs:
  terraform_deploy:
    name: Check Wiz CFN templates for updates
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: CFN_Template
    steps:

    - name: Checkout Repo
      uses: actions/checkout@v3.3.0

    # - name: configure AWS credentials
    #   uses: aws-actions/configure-aws-credentials@v4
    #   with:
    #     aws-region: 'us-east-1'
    #     role-to-assume: ${{ secrets.AWS_ROLE }}
    #     role-duration-seconds: 3600

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16' # or any LTS version you prefer

    - name: Download the latest JSON file
      run: curl -o downloaded.json https://wizio-public.s3.amazonaws.com/deployment-v2/aws/wiz-aws-standard-org.json

    - name: Debug JSON files
      run: |
        echo "Downloaded JSON file content:"
        cat downloaded.json
        echo "Existing JSON file content:"
        cat wiz-aws-standard-org.json

    - name: Compare JSON files
      id: compare
      run: |
        # Normalize and compare JSON files
        if jq -S . downloaded.json > normalized_downloaded.json && \
           jq -S . wiz-aws-standard-org.json > normalized_existing.json && \
           ! diff -q normalized_downloaded.json normalized_existing.json > /dev/null; then
          echo "CHANGED=true" >> $GITHUB_ENV
        else
          echo "CHANGED=false" >> $GITHUB_ENV
        fi

    - name: Update JSON file and create a new branch
      if: env.CHANGED == 'true'
      run: |
        cp downloaded.json wiz-aws-standard-org.json
        git config --global user.name "GitHub Actions"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"
        git fetch origin main # Replace 'main' with your base branch if different
        git checkout main

        branch_name="update-json-$(date +'%Y%m%d%H%M%S')"
        echo "BRANCH_NAME=$branch_name" >> $GITHUB_ENV

        git checkout -b $branch_name
        git add CFN_Template/wiz-aws-standard-org.json
        git commit -m "Update JSON file"
        git push origin $branch_name

  
    - name: Create a Pull Request
      if: env.CHANGED == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ env.BRANCH_NAME }}
        base: main
        title: 'Update JSON file'
        body: 'This PR updates the JSON file with the latest version.'  
        reviewers: cyberviking949 # Add required reviewers here
        #team-reviewers: [] # Add required team reviewers here